"use strict";const e=require("../../common/vendor.js"),a=require("../../api/api.js"),t=require("../../utils/utils.js"),l=require("../../utils/http.js"),i=require("../../utils/wx.js"),o=require("../../enum/user.js");Math||u();const u=()=>"../../uni_modules/lime-confetti/components/l-confetti/l-confetti.js",n={__name:"index",setup(u){const n=new a.Api,s=e.ref(),r=e.ref(!1),v=e.reactive({email:"",code:""}),c=e.ref(0),d=e.ref(""),g=e.ref(),m=e.ref(""),h=e.ref(),f=e.ref(60),p=e.ref(!1);let w;const y=e.ref(0),_=e.ref(0),x=e.ref(!1);e.onShow((()=>{1===c.value&&(x.value=!0)}));const L=async()=>{if(p.value)return;if(!t.isValidEmail(v.email))return void i.toast("输入正确邮箱之后再获取");i.showLoading("获取中...");const e=await n.sendEmail({email:v.email});if(i.hideLoading(),i.toast(e.message),p.value=!0,200===e.code)return j(),void(c.value=1);clearInterval(w),p.value=!1,f.value=60},j=()=>{w=setInterval((()=>{if(0===f.value)return clearInterval(w),p.value=!1,void(f.value=60);f.value--}),1e3)},I=async()=>{if(!t.isValidEmail(v.email))return void i.toast("邮箱格式不正确");if(!v.code||6!==v.code.length)return void i.toast("验证码格式不正确");i.showLoading("处理中..."),r.value=!0;const a=await n.emailLogin(v);if(i.hideLoading(),r.value=!1,200===a.code)return r.value=!1,g.value=a.data,i.setStorage(o.USER_INFO,a.data),void(a.data.is_new_user?(i.toast("注册成功，请完善信息"),c.value=2):(i.toast(a.message),s.value&&(s.value.play({particleCount:100,spread:70,shapes:["circle"],origin:{y:.6}}),setTimeout((()=>{e.index.navigateTo({url:"/pages/layout/index"})}),1500))));i.toast(a.message)},q=async()=>{i.showLoading("处理中...");const e=await n.setUserInfo({id:g.value.id,nick_name:d.value});i.hideLoading(),200===e.code&&(i.toast("设置成功"),c.value=3)},k=()=>{e.index.chooseImage({count:1,mediaType:["image"],sourceType:["album","camera"],camera:"back",success:e=>{m.value=e.tempFilePaths[0],h.value=e.tempFiles[0]}})},E=()=>{i.showLoading("处理中..."),e.index.uploadFile({url:l.VUE_APP_API_URL+"/user/info/up_avatar",filePath:m.value,name:"image",header:{token:i.getStorage(o.USER_INFO).token},success:a=>{const t=JSON.parse(a.data);i.hideLoading(),200===t.code&&(i.toast("设置成功"),s.value&&(s.value.play({particleCount:100,spread:70,shapes:["circle"],origin:{y:.6}}),setTimeout((()=>{e.index.navigateTo({url:"/pages/layout/index"})}),1500)))}})};e.watch((()=>v.code),((e,a)=>{6!==e.length?0!==e.length?e.length>a.length?y.value=e.length:e.length<a.length&&(y.value=e.length-1):y.value=0:I()}));const P=()=>{_.value=c.value,1===c.value&&(x.value=!0)},S=()=>{x.value=!1},T=()=>{x.value=!0};return(a,t)=>e.e({a:e.sr(s,"04ed244c-0",{k:"confettiRef"}),b:0===_.value,c:e.o(L),d:v.email,e:e.o((e=>v.email=e.detail.value)),f:e.f(a.codeDigits,((a,t,l)=>({a:e.t(v.code[t]||""),b:t,c:e.n({"code-input-active":y.value===t&&x.value})}))),g:x.value,h:e.o(I),i:e.o(S),j:v.code,k:e.o((e=>v.code=e.detail.value)),l:e.o(T),m:p.value},p.value?{n:e.t(f.value)}:{},{o:e.o(L),p:2===_.value,q:e.o(q),r:d.value,s:e.o((e=>d.value=e.detail.value)),t:e.o(q),v:m.value&&m.value.length},m.value&&m.value.length?{w:m.value}:{},{x:e.o(k),y:e.o(E),z:`translateX(-${100*c.value}vw)`,A:e.o(P)})}};wx.createPage(n);
